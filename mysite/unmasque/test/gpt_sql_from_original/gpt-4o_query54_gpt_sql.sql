WITH web_catalog_purchases AS ( SELECT DISTINCT cs_bill_customer_sk AS customer_sk FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE i_category = 'Electronics' AND i_class = 'Premium' AND d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_month_seq = 202309) UNION SELECT DISTINCT ws_bill_customer_sk AS customer_sk FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE i_category = 'Electronics' AND i_class = 'Premium' AND d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_month_seq = 202309) ), in_store_purchases AS ( SELECT DISTINCT ss_customer_sk AS customer_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq BETWEEN (SELECT d_month_seq FROM date_dim WHERE d_month_seq = 202310) AND (SELECT d_month_seq FROM date_dim WHERE d_month_seq = 202312) ), eligible_customers AS ( SELECT customer_sk FROM web_catalog_purchases INTERSECT SELECT customer_sk FROM in_store_purchases ), customer_revenue AS ( SELECT ec.customer_sk, SUM(cs_net_paid_inc_tax) AS total_revenue FROM eligible_customers ec JOIN catalog_sales cs ON ec.customer_sk = cs.cs_bill_customer_sk GROUP BY ec.customer_sk UNION ALL SELECT ec.customer_sk, SUM(ws_net_paid_inc_tax) AS total_revenue FROM eligible_customers ec JOIN web_sales ws ON ec.customer_sk = ws.ws_bill_customer_sk GROUP BY ec.customer_sk ) SELECT FLOOR(total_revenue / 50) * 50 AS revenue_segment, COUNT(DISTINCT customer_sk) AS customer_count FROM customer_revenue GROUP BY revenue_segment ORDER BY revenue_segment;
