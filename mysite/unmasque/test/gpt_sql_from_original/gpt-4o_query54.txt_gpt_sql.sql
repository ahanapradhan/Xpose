WITH web_catalog_sales AS ( SELECT cs_bill_customer_sk AS customer_sk, SUM(cs_net_paid_inc_tax) AS total_revenue FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE i_category = 'given_category' AND i_class = 'given_class' AND d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_moy = given_month AND d_year = given_year) GROUP BY cs_bill_customer_sk UNION ALL SELECT ws_bill_customer_sk AS customer_sk, SUM(ws_net_paid_inc_tax) AS total_revenue FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE i_category = 'given_category' AND i_class = 'given_class' AND d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_moy = given_month AND d_year = given_year) GROUP BY ws_bill_customer_sk ), in_store_purchases AS ( SELECT DISTINCT ss_customer_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq BETWEEN (SELECT d_month_seq FROM date_dim WHERE d_moy = given_month AND d_year = given_year) + 1 AND (SELECT d_month_seq FROM date_dim WHERE d_moy = given_month AND d_year = given_year) + 3 ), eligible_customers AS ( SELECT customer_sk, SUM(total_revenue) AS total_revenue FROM web_catalog_sales WHERE customer_sk IN (SELECT ss_customer_sk FROM in_store_purchases) GROUP BY customer_sk ) SELECT FLOOR(total_revenue / 50) * 50 AS revenue_segment, COUNT(*) AS customer_count FROM eligible_customers GROUP BY FLOOR(total_revenue / 50) * 50 ORDER BY revenue_segment; Replace `given_category`, `given_class`, `given_month`, and `given_year` with the actual values you want to use in the query.
