WITH MonthlyStats AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, AVG(inv_quantity_on_hand) AS mean_quantity, STDDEV(inv_quantity_on_hand) AS stddev_quantity FROM inventory JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_month_seq IN ( SELECT DISTINCT d_month_seq FROM date_dim ORDER BY d_month_seq DESC LIMIT 2 ) GROUP BY inv_item_sk, inv_warehouse_sk, d_month_seq ), CoefficientOfVariation AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, stddev_quantity / NULLIF(mean_quantity, 0) AS coefficient_of_variation FROM MonthlyStats ), FilteredItems AS ( SELECT inv_item_sk, inv_warehouse_sk FROM CoefficientOfVariation WHERE d_month_seq = (SELECT MAX(d_month_seq) FROM CoefficientOfVariation) - 1 AND coefficient_of_variation >= 1.5 ) SELECT * FROM FilteredItems;
