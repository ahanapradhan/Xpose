WITH PriceChanges AS ( SELECT i_item_sk, i_rec_start_date AS price_change_date FROM item WHERE i_rec_start_date IS NOT NULL ), InventoryBefore AS ( SELECT inv_warehouse_sk, inv_item_sk, SUM(inv_quantity_on_hand) AS total_quantity_before FROM inventory JOIN PriceChanges ON inventory.inv_item_sk = PriceChanges.i_item_sk JOIN date_dim ON inventory.inv_date_sk = date_dim.d_date_sk WHERE date_dim.d_date BETWEEN PriceChanges.price_change_date - INTERVAL '30' DAY AND PriceChanges.price_change_date - INTERVAL '1' DAY GROUP BY inv_warehouse_sk, inv_item_sk ), InventoryAfter AS ( SELECT inv_warehouse_sk, inv_item_sk, SUM(inv_quantity_on_hand) AS total_quantity_after FROM inventory JOIN PriceChanges ON inventory.inv_item_sk = PriceChanges.i_item_sk JOIN date_dim ON inventory.inv_date_sk = date_dim.d_date_sk WHERE date_dim.d_date BETWEEN PriceChanges.price_change_date + INTERVAL '1' DAY AND PriceChanges.price_change_date + INTERVAL '30' DAY GROUP BY inv_warehouse_sk, inv_item_sk ) SELECT w.w_warehouse_id, (InventoryAfter.total_quantity_after - InventoryBefore.total_quantity_before) * 100.0 / NULLIF(InventoryBefore.total_quantity_before, 0) AS percentage_change FROM InventoryBefore JOIN InventoryAfter ON InventoryBefore.inv_warehouse_sk = InventoryAfter.inv_warehouse_sk AND InventoryBefore.inv_item_sk = InventoryAfter.inv_item_sk JOIN warehouse w ON InventoryBefore.inv_warehouse_sk = w.w_warehouse_sk GROUP BY w.w_warehouse_id, InventoryBefore.total_quantity_before, InventoryAfter.total_quantity_after;
