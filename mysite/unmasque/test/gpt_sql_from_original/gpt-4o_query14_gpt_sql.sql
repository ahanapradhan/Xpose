WITH CrossChannelSales AS ( SELECT i_brand, i_class, i_category, cs_item_sk, d_year, SUM(cs_quantity * cs_list_price) AS total_sales, COUNT(*) AS num_sales FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (2021, 2022) GROUP BY i_brand, i_class, i_category, cs_item_sk, d_year HAVING COUNT(DISTINCT cs_call_center_sk) = 3 ), AverageSales AS ( SELECT AVG(total_sales) AS avg_sales FROM CrossChannelSales ), FilteredSales AS ( SELECT i_brand, i_class, i_category, d_year, total_sales, num_sales FROM CrossChannelSales, AverageSales WHERE total_sales > avg_sales ) SELECT i_brand, i_class, i_category, d_year, SUM(total_sales) AS total_sales, SUM(num_sales) AS total_num_sales FROM FilteredSales GROUP BY i_brand, i_class, i_category, d_year; SELECT ss_item_sk, SUM(ss_quantity * ss_list_price) AS december_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq = 12 AND d_year = 2022 GROUP BY ss_item_sk;
