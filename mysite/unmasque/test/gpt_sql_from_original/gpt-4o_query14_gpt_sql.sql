WITH cross_channel_sales AS ( SELECT i_brand, i_class, i_category, cs_item_sk, d_year, SUM(cs_quantity * cs_list_price) AS total_sales, COUNT(*) AS num_sales FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (1998, 1999) GROUP BY i_brand, i_class, i_category, cs_item_sk, d_year HAVING COUNT(DISTINCT cs_call_center_sk) = 3 ), average_sales AS ( SELECT AVG(total_sales) AS avg_sales FROM cross_channel_sales ), filtered_sales AS ( SELECT i_brand, i_class, i_category, d_year, total_sales, num_sales FROM cross_channel_sales WHERE total_sales > (SELECT avg_sales FROM average_sales) ) SELECT i_brand, i_class, i_category, d_year, SUM(total_sales) AS total_sales, SUM(num_sales) AS total_num_sales FROM filtered_sales GROUP BY i_brand, i_class, i_category, d_year UNION ALL SELECT 'Store', 'Store', 'Store', 1999, SUM(ss_quantity * ss_list_price) AS total_sales, COUNT(*) AS num_sales FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy = 12 GROUP BY d_year;
