WITH cross_channel_sales AS ( SELECT i_brand, i_class, i_category, cs_item_sk FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) INTERSECT SELECT i_brand, i_class, i_category, ss_item_sk FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) INTERSECT SELECT i_brand, i_class, i_category, ws_item_sk FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) ), average_sales AS ( SELECT AVG(cs_quantity * cs_list_price) AS avg_sales FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) UNION ALL SELECT AVG(ss_quantity * ss_list_price) AS avg_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) UNION ALL SELECT AVG(ws_quantity * ws_list_price) AS avg_sales FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) ), filtered_sales AS ( SELECT 'catalog' AS channel, i_brand, i_class, i_category, SUM(cs_quantity * cs_list_price) AS total_sales, COUNT(*) AS total_count FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) AND cs_quantity * cs_list_price > (SELECT AVG(avg_sales) FROM average_sales) GROUP BY i_brand, i_class, i_category UNION ALL SELECT 'store' AS channel, i_brand, i_class, i_category, SUM(ss_quantity * ss_list_price) AS total_sales, COUNT(*) AS total_count FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) AND ss_quantity * ss_list_price > (SELECT AVG(avg_sales) FROM average_sales) GROUP BY i_brand, i_class, i_category UNION ALL SELECT 'web' AS channel, i_brand, i_class, i_category, SUM(ws_quantity * ws_list_price) AS total_sales, COUNT(*) AS total_count FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year IN (1999, 2000) AND ws_quantity * ws_list_price > (SELECT AVG(avg_sales) FROM average_sales) GROUP BY i_brand, i_class, i_category ) SELECT * FROM filtered_sales WHERE channel = 'store' AND EXISTS ( SELECT 1 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy = 12 );
