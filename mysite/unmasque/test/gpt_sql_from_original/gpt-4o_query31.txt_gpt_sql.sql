WITH web_sales_growth AS ( SELECT ca_county, d_year, d_quarter_seq, SUM(ws_net_paid) AS total_web_sales FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk GROUP BY ca_county, d_year, d_quarter_seq ), store_sales_growth AS ( SELECT s_county, d_year, d_quarter_seq, SUM(ss_net_paid) AS total_store_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk GROUP BY s_county, d_year, d_quarter_seq ), growth_comparison AS ( SELECT wsg.ca_county, wsg.d_year, wsg.d_quarter_seq, (wsg.total_web_sales - LAG(wsg.total_web_sales) OVER (PARTITION BY wsg.ca_county, wsg.d_year ORDER BY wsg.d_quarter_seq)) / NULLIF(LAG(wsg.total_web_sales) OVER (PARTITION BY wsg.ca_county, wsg.d_year ORDER BY wsg.d_quarter_seq), 0) AS web_growth, (ssg.total_store_sales - LAG(ssg.total_store_sales) OVER (PARTITION BY ssg.s_county, ssg.d_year ORDER BY ssg.d_quarter_seq)) / NULLIF(LAG(ssg.total_store_sales) OVER (PARTITION BY ssg.s_county, ssg.d_year ORDER BY ssg.d_quarter_seq), 0) AS store_growth FROM web_sales_growth wsg JOIN store_sales_growth ssg ON wsg.ca_county = ssg.s_county AND wsg.d_year = ssg.d_year AND wsg.d_quarter_seq = ssg.d_quarter_seq ) SELECT ca_county FROM growth_comparison WHERE web_growth > store_growth GROUP BY ca_county, d_year HAVING COUNT(*) = 3 ORDER BY ca_county;
