WITH CustomerSales AS ( SELECT c.c_first_name, c.c_last_name, s.s_store_name, SUM(ss.ss_net_paid) AS total_value FROM store_sales ss JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color = 'Red' AND s.s_market_id = 1 AND c.c_birth_country = ca.ca_country AND ca.ca_city = s.s_city GROUP BY c.c_first_name, c.c_last_name, s.s_store_name ), AverageValue AS ( SELECT AVG(total_value) AS avg_value FROM CustomerSales ) SELECT cs.c_first_name, cs.c_last_name, cs.s_store_name, cs.total_value FROM CustomerSales cs CROSS JOIN AverageValue av WHERE cs.total_value > 0.05 * av.avg_value;
