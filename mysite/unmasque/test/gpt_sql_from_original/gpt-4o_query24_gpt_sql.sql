WITH CustomerInBirthCountry AS ( SELECT c_customer_sk FROM customer JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE c_birth_country = ca_country ), CustomerInNeighborhood AS ( SELECT c_customer_sk FROM customer JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN store ON ca_city = s_city AND ca_county = s_county AND ca_state = s_state WHERE s_market_id = 8 ), AverageValue AS ( SELECT AVG(ss_net_paid) * 0.05 AS avg_value FROM store_sales JOIN store ON ss_store_sk = s_store_sk WHERE s_market_id = 8 ), Iteration1 AS ( SELECT c_first_name, c_last_name, s_store_name, SUM(ss_net_paid) AS total_value FROM store_sales JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE i_color = 'pale' AND s_market_id = 8 AND c_customer_sk IN (SELECT c_customer_sk FROM CustomerInBirthCountry) AND c_customer_sk IN (SELECT c_customer_sk FROM CustomerInNeighborhood) GROUP BY c_first_name, c_last_name, s_store_name HAVING SUM(ss_net_paid) > (SELECT avg_value FROM AverageValue) ), Iteration2 AS ( SELECT c_first_name, c_last_name, s_store_name, SUM(ss_net_paid) AS total_value FROM store_sales JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE i_color = 'chiffon' AND s_market_id = 8 AND c_customer_sk IN (SELECT c_customer_sk FROM CustomerInBirthCountry) AND c_customer_sk IN (SELECT c_customer_sk FROM CustomerInNeighborhood) GROUP BY c_first_name, c_last_name, s_store_name HAVING SUM(ss_net_paid) > (SELECT avg_value FROM AverageValue) ) SELECT * FROM Iteration1 UNION ALL SELECT * FROM Iteration2;
