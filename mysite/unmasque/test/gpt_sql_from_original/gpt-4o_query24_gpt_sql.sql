WITH AvgValue AS ( SELECT AVG(ss_net_paid) * 0.05 AS avg_value FROM store_sales JOIN store ON store_sales.ss_store_sk = store.s_store_sk WHERE store.s_market_id = 6 ), FilteredCustomers AS ( SELECT c_customer_sk, c_first_name, c_last_name, s_store_id, SUM(ss_net_paid) AS total_value FROM store_sales JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN store ON store_sales.ss_store_sk = store.s_store_sk JOIN item ON store_sales.ss_item_sk = item.i_item_sk WHERE store.s_market_id = 6 AND customer.c_birth_country = customer_address.ca_country AND customer_address.ca_city = store.s_city AND item.i_color = 'papaya' GROUP BY c_customer_sk, c_first_name, c_last_name, s_store_id HAVING SUM(ss_net_paid) > (SELECT avg_value FROM AvgValue) ) SELECT c_first_name, c_last_name, s_store_id, total_value FROM FilteredCustomers UNION ALL SELECT c_first_name, c_last_name, s_store_id, total_value FROM ( SELECT c_customer_sk, c_first_name, c_last_name, s_store_id, SUM(ss_net_paid) AS total_value FROM store_sales JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN store ON store_sales.ss_store_sk = store.s_store_sk JOIN item ON store_sales.ss_item_sk = item.i_item_sk WHERE store.s_market_id = 6 AND customer.c_birth_country = customer_address.ca_country AND customer_address.ca_city = store.s_city AND item.i_color = 'chartreuse' GROUP BY c_customer_sk, c_first_name, c_last_name, s_store_id HAVING SUM(ss_net_paid) > (SELECT avg_value FROM AvgValue) ) AS Iteration2;
