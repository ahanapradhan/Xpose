WITH returns_summary AS ( SELECT sr_item_sk AS item_sk, COALESCE(SUM(sr_return_quantity), 0) AS store_returns, COALESCE(SUM(cr_return_quantity), 0) AS catalog_returns, COALESCE(SUM(wr_return_quantity), 0) AS web_returns FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk LEFT JOIN catalog_returns ON sr_item_sk = cr_item_sk AND cr_returned_date_sk = d_date_sk LEFT JOIN web_returns ON sr_item_sk = wr_item_sk AND wr_returned_date_sk = d_date_sk WHERE d_date BETWEEN CAST(? AS DATE) - INTERVAL '6 DAY' AND CAST(? AS DATE) GROUP BY sr_item_sk ), filtered_returns AS ( SELECT item_sk, store_returns, catalog_returns, web_returns, (store_returns + catalog_returns + web_returns) AS total_returns FROM returns_summary WHERE ABS(store_returns - catalog_returns) <= 0.1 * store_returns AND ABS(store_returns - web_returns) <= 0.1 * store_returns AND ABS(catalog_returns - web_returns) <= 0.1 * catalog_returns ) SELECT item_sk FROM filtered_returns ORDER BY total_returns DESC LIMIT 1;
