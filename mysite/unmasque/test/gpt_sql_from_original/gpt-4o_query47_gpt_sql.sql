SELECT i.i_category, i.i_brand, s.s_store_name, s.s_company_name, monthly_sales.d_year, monthly_sales.d_moy, (monthly_sales.ss_monthly_sales - avg_sales.avg_monthly_sales) / avg_sales.avg_monthly_sales * 100 AS deviation FROM (SELECT ss.ss_item_sk, ss.ss_store_sk, d.d_year, d.d_moy, SUM(ss.ss_net_paid) AS ss_monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY ss.ss_item_sk, ss.ss_store_sk, d.d_year, d.d_moy) monthly_sales JOIN (SELECT ss.ss_item_sk, ss.ss_store_sk, d.d_year, AVG(SUM(ss.ss_net_paid)) OVER (PARTITION BY ss.ss_item_sk, ss.ss_store_sk, d.d_year) AS avg_monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY ss.ss_item_sk, ss.ss_store_sk, d.d_year, d.d_moy) avg_sales ON monthly_sales.ss_item_sk = avg_sales.ss_item_sk AND monthly_sales.ss_store_sk = avg_sales.ss_store_sk AND monthly_sales.d_year = avg_sales.d_year JOIN item i ON monthly_sales.ss_item_sk = i.i_item_sk JOIN store s ON monthly_sales.ss_store_sk = s.s_store_sk WHERE ABS((monthly_sales.ss_monthly_sales - avg_sales.avg_monthly_sales) / avg_sales.avg_monthly_sales) > 0.10 ORDER BY deviation DESC, s.s_store_name;
