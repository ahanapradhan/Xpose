SELECT i.i_category, i.i_brand, s.s_store_name, s.s_company_name, monthly_sales.d_year, monthly_sales.d_moy, monthly_sales.ss_monthly_sales, monthly_sales.ss_monthly_sales - LAG(monthly_sales.ss_monthly_sales) OVER (PARTITION BY s.s_store_sk ORDER BY monthly_sales.d_moy) AS deviation_from_previous_month, LEAD(monthly_sales.ss_monthly_sales) OVER (PARTITION BY s.s_store_sk ORDER BY monthly_sales.d_moy) - monthly_sales.ss_monthly_sales AS deviation_from_next_month FROM (SELECT ss.ss_store_sk, ss.ss_item_sk, d.d_year, d.d_moy, SUM(ss.ss_net_paid) AS ss_monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY ss.ss_store_sk, ss.ss_item_sk, d.d_year, d.d_moy) AS monthly_sales JOIN (SELECT ss_store_sk, AVG(ss_monthly_sales) AS avg_monthly_sales FROM (SELECT ss.ss_store_sk, ss.ss_item_sk, d.d_year, d.d_moy, SUM(ss.ss_net_paid) AS ss_monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY ss.ss_store_sk, ss.ss_item_sk, d.d_year, d.d_moy) AS monthly_sales GROUP BY ss_store_sk) AS avg_sales ON monthly_sales.ss_store_sk = avg_sales.ss_store_sk JOIN item i ON monthly_sales.ss_item_sk = i.i_item_sk JOIN store s ON monthly_sales.ss_store_sk = s.s_store_sk WHERE ABS(monthly_sales.ss_monthly_sales - avg_sales.avg_monthly_sales) > 0.1 * avg_sales.avg_monthly_sales ORDER BY ABS(monthly_sales.ss_monthly_sales - avg_sales.avg_monthly_sales) DESC, s.s_store_name;
