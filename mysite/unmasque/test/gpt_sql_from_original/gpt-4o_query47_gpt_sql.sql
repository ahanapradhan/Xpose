WITH MonthlySales AS ( SELECT i.i_category, i.i_brand, s.s_store_name, s.s_company_name, d.d_year, d.d_moy, SUM(ss.ss_net_paid) AS monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 1999 GROUP BY i.i_category, i.i_brand, s.s_store_name, s.s_company_name, d.d_year, d.d_moy ), AverageMonthlySales AS ( SELECT i_category, i_brand, s_store_name, s_company_name, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY i_category, i_brand, s_store_name, s_company_name ), SalesDeviation AS ( SELECT ms.i_category, ms.i_brand, ms.s_store_name, ms.s_company_name, ms.d_year, ms.d_moy, ms.monthly_sales, ms.monthly_sales - LAG(ms.monthly_sales) OVER (PARTITION BY ms.i_category, ms.i_brand, ms.s_store_name, ms.s_company_name ORDER BY ms.d_moy) AS prev_deviation, LEAD(ms.monthly_sales) OVER (PARTITION BY ms.i_category, ms.i_brand, ms.s_store_name, ms.s_company_name ORDER BY ms.d_moy) - ms.monthly_sales AS next_deviation, abs(ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales * 100 AS deviation_percentage FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.i_category = ams.i_category AND ms.i_brand = ams.i_brand AND ms.s_store_name = ams.s_store_name AND ms.s_company_name = ams.s_company_name ) SELECT i_category, i_brand, s_store_name, s_company_name, d_year, d_moy, monthly_sales, prev_deviation, next_deviation, deviation_percentage FROM SalesDeviation WHERE deviation_percentage > 10 ORDER BY deviation_percentage DESC, s_store_name;
