SELECT c.c_customer_id, c.c_first_name, c.c_last_name, ca.ca_country FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN ( SELECT cs.cs_bill_customer_sk AS customer_sk, SUM(cs.cs_net_paid_inc_tax) AS catalog_sales_total FROM catalog_sales cs GROUP BY cs.cs_bill_customer_sk ) catalog_totals ON c.c_customer_sk = catalog_totals.customer_sk LEFT JOIN ( SELECT ss.ss_customer_sk AS customer_sk, SUM(ss.ss_net_paid_inc_tax) AS store_sales_total FROM store_sales ss GROUP BY ss.ss_customer_sk ) store_totals ON c.c_customer_sk = store_totals.customer_sk WHERE catalog_totals.catalog_sales_total > COALESCE(store_totals.store_sales_total, 0) AND c.c_preferred_cust_flag = 'Y';
