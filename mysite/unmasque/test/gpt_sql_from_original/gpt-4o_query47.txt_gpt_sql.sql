WITH MonthlySales AS ( SELECT i.i_category, i.i_brand, s.s_store_name, s.s_company_name, d.d_year, d.d_moy, SUM(ss.ss_net_paid) AS monthly_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 1999 GROUP BY i.i_category, i.i_brand, s.s_store_name, s.s_company_name, d.d_year, d.d_moy ), AverageMonthlySales AS ( SELECT i_category, i_brand, s_store_name, s_company_name, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY i_category, i_brand, s_store_name, s_company_name ), SalesDeviation AS ( SELECT ms.i_category, ms.i_brand, ms.s_store_name, ms.s_company_name, ms.d_year, ms.d_moy, ms.monthly_sales, ams.avg_monthly_sales, (ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales * 100 AS deviation FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.i_category = ams.i_category AND ms.i_brand = ams.i_brand AND ms.s_store_name = ams.s_store_name AND ms.s_company_name = ams.s_company_name WHERE ABS((ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales * 100) > 10 ) SELECT sd.i_category, sd.i_brand, sd.s_store_name, sd.s_company_name, sd.d_year, sd.d_moy, sd.monthly_sales, sd.deviation FROM SalesDeviation sd ORDER BY sd.deviation DESC, sd.s_store_name;
