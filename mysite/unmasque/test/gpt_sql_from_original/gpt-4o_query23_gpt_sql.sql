WITH FrequentItems AS ( SELECT ss_item_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 2019 AND 2022 GROUP BY ss_item_sk, d_date HAVING COUNT(*) > 4 ), MaxStoreSales AS ( SELECT ss_customer_sk, MAX(total_sales) AS max_sales FROM ( SELECT ss_customer_sk, SUM(ss_net_paid) AS total_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 2019 AND 2022 GROUP BY ss_customer_sk, d_year ) AS yearly_sales GROUP BY ss_customer_sk ), BestCustomers AS ( SELECT ss_customer_sk FROM ( SELECT ss_customer_sk, NTILE(100) OVER (ORDER BY max_sales DESC) AS percentile FROM MaxStoreSales ) AS ranked_customers WHERE percentile <= 5 ), MarchSales AS ( SELECT ss_customer_sk, ss_item_sk, SUM(ss_net_paid) AS total_march_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq % 12 = 3 GROUP BY ss_customer_sk, ss_item_sk ) SELECT SUM(total_march_sales) AS total_sales_in_march FROM MarchSales WHERE ss_customer_sk IN (SELECT ss_customer_sk FROM BestCustomers) AND ss_item_sk IN (SELECT ss_item_sk FROM FrequentItems);
