WITH FrequentItems AS ( SELECT ss_item_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 2000 AND 2003 GROUP BY ss_item_sk, d_date HAVING COUNT(*) > 4 ), MaxStoreSales AS ( SELECT ss_customer_sk, MAX(total_sales) AS max_sales FROM ( SELECT ss_customer_sk, SUM(ss_net_paid) AS total_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 2000 AND 2003 GROUP BY ss_customer_sk, d_year ) AS yearly_sales GROUP BY ss_customer_sk ), BestCustomers AS ( SELECT ss_customer_sk FROM ( SELECT ss_customer_sk, RANK() OVER (ORDER BY max_sales DESC) AS sales_rank FROM MaxStoreSales ) AS ranked_customers WHERE sales_rank <= (SELECT COUNT(*) * 0.05 FROM MaxStoreSales) ), MarchSales AS ( SELECT ss_customer_sk, ss_item_sk, SUM(ss_net_paid) AS total_march_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq = 2 AND d_year BETWEEN 2000 AND 2003 GROUP BY ss_customer_sk, ss_item_sk ) SELECT SUM(total_march_sales) AS total_sales_in_march FROM MarchSales WHERE ss_customer_sk IN (SELECT ss_customer_sk FROM BestCustomers) AND ss_item_sk IN (SELECT ss_item_sk FROM FrequentItems);
