WITH MonthlySales AS ( SELECT cs.cs_call_center_sk, i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, SUM(cs.cs_ext_sales_price) AS monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2000 GROUP BY cs.cs_call_center_sk, i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy ), AverageMonthlySales AS ( SELECT cs_call_center_sk, i_category, i_brand, cc_name, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY cs_call_center_sk, i_category, i_brand, cc_name ), SalesDeviation AS ( SELECT ms.cs_call_center_sk, ms.i_category, ms.i_brand, ms.cc_name, ms.d_year, ms.d_moy, ms.monthly_sales, ams.avg_monthly_sales, ms.monthly_sales - LAG(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_category, ms.i_brand ORDER BY ms.d_moy) AS prev_month_deviation, LEAD(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_category, ms.i_brand ORDER BY ms.d_moy) - ms.monthly_sales AS next_month_deviation FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.cs_call_center_sk = ams.cs_call_center_sk AND ms.i_category = ams.i_category AND ms.i_brand = ams.i_brand AND ms.cc_name = ams.cc_name WHERE ABS(ms.monthly_sales - ams.avg_monthly_sales) > 0.1 * ams.avg_monthly_sales ) SELECT i_category, i_brand, cc_name, d_year, d_moy, monthly_sales, prev_month_deviation, next_month_deviation FROM SalesDeviation ORDER BY ABS(monthly_sales - avg_monthly_sales) DESC, cs_call_center_sk;
