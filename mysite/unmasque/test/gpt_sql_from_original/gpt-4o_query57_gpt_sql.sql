WITH MonthlySales AS ( SELECT cs.cs_call_center_sk, i.i_category, i.i_brand, d.d_year, d.d_moy, SUM(cs.cs_ext_sales_price) AS monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY cs.cs_call_center_sk, i.i_category, i.i_brand, d.d_year, d.d_moy ), AverageMonthlySales AS ( SELECT cs_call_center_sk, i_category, i_brand, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY cs_call_center_sk, i_category, i_brand ), SalesDeviation AS ( SELECT ms.cs_call_center_sk, ms.i_category, ms.i_brand, ms.d_year, ms.d_moy, ms.monthly_sales, ms.monthly_sales - COALESCE(LAG(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_category, ms.i_brand ORDER BY ms.d_moy), 0) AS prev_month_deviation, ms.monthly_sales - COALESCE(LEAD(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_category, ms.i_brand ORDER BY ms.d_moy), 0) AS next_month_deviation, abs(ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales AS deviation FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.cs_call_center_sk = ams.cs_call_center_sk AND ms.i_category = ams.i_category AND ms.i_brand = ams.i_brand ) SELECT v1.i_category, v1.i_brand, cc.cc_name, v1.d_year, v1.d_moy, v1.prev_month_deviation, v1.next_month_deviation FROM SalesDeviation v1 JOIN call_center cc ON v1.cs_call_center_sk = cc.cc_call_center_sk WHERE v1.deviation > 0.10 ORDER BY v1.deviation DESC, cc.cc_name;
