WITH MonthlySales AS ( SELECT cs.cs_call_center_sk, i.i_brand, i.i_category, d.d_month_seq, SUM(cs.cs_ext_sales_price) AS monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2022 GROUP BY cs.cs_call_center_sk, i.i_brand, i.i_category, d.d_month_seq ), AverageMonthlySales AS ( SELECT cs_call_center_sk, i_brand, i_category, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY cs_call_center_sk, i_brand, i_category ), SalesDeviation AS ( SELECT ms.cs_call_center_sk, ms.i_brand, ms.i_category, ms.d_month_seq, ms.monthly_sales, ms.monthly_sales - LAG(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_brand, ms.i_category ORDER BY ms.d_month_seq) AS prev_month_deviation, LEAD(ms.monthly_sales) OVER (PARTITION BY ms.cs_call_center_sk, ms.i_brand, ms.i_category ORDER BY ms.d_month_seq) - ms.monthly_sales AS next_month_deviation, ABS(ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales AS deviation_percentage FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.cs_call_center_sk = ams.cs_call_center_sk AND ms.i_brand = ams.i_brand AND ms.i_category = ams.i_category ) SELECT cs_call_center_sk, i_brand, i_category, d_month_seq, monthly_sales, prev_month_deviation, next_month_deviation, deviation_percentage FROM SalesDeviation WHERE deviation_percentage > 0.10 ORDER BY deviation_percentage DESC, cs_call_center_sk;
