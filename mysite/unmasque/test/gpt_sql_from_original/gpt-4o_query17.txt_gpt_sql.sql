SELECT ca.ca_state, i.i_item_id, COUNT(DISTINCT cs.cs_order_number) AS num_re_purchases FROM store_sales ss JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN catalog_sales cs ON sr.sr_item_sk = cs.cs_item_sk AND sr.sr_customer_sk = cs.cs_bill_customer_sk JOIN date_dim d_ss ON ss.ss_sold_date_sk = d_ss.d_date_sk JOIN date_dim d_sr ON sr.sr_returned_date_sk = d_sr.d_date_sk JOIN date_dim d_cs ON cs.cs_sold_date_sk = d_cs.d_date_sk JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d_sr.d_quarter_seq BETWEEN d_ss.d_quarter_seq + 1 AND d_ss.d_quarter_seq + 3 AND d_cs.d_quarter_seq BETWEEN d_sr.d_quarter_seq + 1 AND d_sr.d_quarter_seq + 3 GROUP BY ca.ca_state, i.i_item_id ORDER BY ca.ca_state, num_re_purchases DESC;
