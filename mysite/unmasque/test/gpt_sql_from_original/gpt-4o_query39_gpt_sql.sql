WITH MonthlyStats AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, AVG(inv_quantity_on_hand) AS mean_quantity, STDDEV(inv_quantity_on_hand) / NULLIF(AVG(inv_quantity_on_hand), 0) AS coeff_variation FROM inventory JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_month_seq IN (SELECT DISTINCT d_month_seq FROM date_dim ORDER BY d_month_seq DESC LIMIT 2) GROUP BY inv_item_sk, inv_warehouse_sk, d_month_seq ), FilteredItems AS ( SELECT inv_item_sk FROM MonthlyStats WHERE d_month_seq = (SELECT MAX(d_month_seq) FROM MonthlyStats) - 1 AND coeff_variation >= 1.5 ) SELECT * FROM MonthlyStats WHERE inv_item_sk IN (SELECT inv_item_sk FROM FilteredItems);
