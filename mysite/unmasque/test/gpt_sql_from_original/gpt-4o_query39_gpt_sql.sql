WITH MonthlyStats AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, AVG(inv_quantity_on_hand) AS mean_quantity, STDDEV(inv_quantity_on_hand) / NULLIF(AVG(inv_quantity_on_hand), 0) AS coeff_variation FROM inventory JOIN date_dim ON inv_date_sk = d_date_sk WHERE (d_year = 2001 AND d_moy IN (1, 2)) GROUP BY inv_item_sk, inv_warehouse_sk, d_month_seq ), FilteredItems AS ( SELECT inv_item_sk FROM MonthlyStats WHERE d_month_seq = (SELECT MIN(d_month_seq) FROM date_dim WHERE d_year = 2001 AND d_moy = 1) AND coeff_variation >= 1.5 ) SELECT inv_item_sk, inv_warehouse_sk, mean_quantity, coeff_variation FROM MonthlyStats WHERE inv_item_sk IN (SELECT inv_item_sk FROM FilteredItems);
