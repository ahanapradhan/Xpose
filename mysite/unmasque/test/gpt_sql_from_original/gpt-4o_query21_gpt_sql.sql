SELECT w.w_warehouse_id, i.i_item_id, (SUM(CASE WHEN d.d_date < pc.d_date THEN inv.inv_quantity_on_hand ELSE 0 END) - SUM(CASE WHEN d.d_date >= pc.d_date THEN inv.inv_quantity_on_hand ELSE 0 END)) / NULLIF(SUM(CASE WHEN d.d_date < pc.d_date THEN inv.inv_quantity_on_hand ELSE 0 END), 0) * 100 AS percentage_change FROM inventory inv JOIN item i ON inv.inv_item_sk = i.i_item_sk JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN (SELECT i_item_sk, MIN(d_date) AS d_date FROM item JOIN date_dim ON i_rec_start_date = d_date WHERE i_rec_start_date IS NOT NULL GROUP BY i_item_sk) pc ON i.i_item_sk = pc.i_item_sk WHERE d.d_date BETWEEN pc.d_date - INTERVAL '30 days' AND pc.d_date + INTERVAL '30 days' GROUP BY w.w_warehouse_id, i.i_item_id;
