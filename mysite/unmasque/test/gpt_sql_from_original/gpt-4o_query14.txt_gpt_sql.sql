WITH cross_channel_sales AS ( SELECT i_brand, i_class, i_category, cs_item_sk, d_year, SUM(cs_quantity * cs_list_price) AS total_sales, COUNT(*) AS num_sales FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year IN (SELECT DISTINCT d_year FROM date_dim WHERE d_year BETWEEN 2000 AND 2002) GROUP BY i_brand, i_class, i_category, cs_item_sk, d_year HAVING COUNT(DISTINCT cs_sold_date_sk) = 3 ), average_sales AS ( SELECT AVG(total_sales) AS avg_sales FROM cross_channel_sales ), filtered_sales AS ( SELECT i_brand, i_class, i_category, d_year, total_sales, num_sales FROM cross_channel_sales WHERE total_sales > (SELECT avg_sales FROM average_sales) ), rolled_up_sales AS ( SELECT i_brand, i_class, i_category, d_year, SUM(total_sales) AS total_sales, SUM(num_sales) AS total_num_sales FROM filtered_sales GROUP BY i_brand, i_class, i_category, d_year ), december_store_sales AS ( SELECT i_brand, i_class, i_category, SUM(ss_quantity * ss_list_price) AS december_sales FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq = 12 GROUP BY i_brand, i_class, i_category ) SELECT r.i_brand, r.i_class, r.i_category, r.d_year, r.total_sales, r.total_num_sales, d.december_sales FROM rolled_up_sales r JOIN december_store_sales d ON r.i_brand = d.i_brand AND r.i_class = d.i_class AND r.i_category = d.i_category WHERE r.d_year = 2001;
