WITH CustomerSales AS ( SELECT c.c_first_name, c.c_last_name, s.s_store_name, SUM(ss.ss_sales_price) AS total_sales FROM store_sales ss JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color = 'specific_color' AND s.s_market_id = (SELECT s_market_id FROM store WHERE s_market_desc = 'specific_market_desc') AND c.c_birth_country = ca.ca_country AND ca.ca_city = s.s_city GROUP BY c.c_first_name, c.c_last_name, s.s_store_name ), AverageSales AS ( SELECT AVG(total_sales) AS avg_sales FROM CustomerSales ) SELECT cs.c_first_name, cs.c_last_name, cs.s_store_name, cs.total_sales FROM CustomerSales cs CROSS JOIN AverageSales WHERE cs.total_sales > 0.05 * AverageSales.avg_sales;
