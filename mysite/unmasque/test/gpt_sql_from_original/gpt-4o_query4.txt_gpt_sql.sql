SELECT c.c_customer_id, c.c_first_name, c.c_last_name, ca.ca_country FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN ( SELECT cs_bill_customer_sk AS customer_sk, SUM(cs_net_paid_inc_tax) AS catalog_spending FROM catalog_sales GROUP BY cs_bill_customer_sk ) catalog ON c.c_customer_sk = catalog.customer_sk LEFT JOIN ( SELECT ss_customer_sk AS customer_sk, SUM(ss_net_paid_inc_tax) AS store_spending FROM store_sales GROUP BY ss_customer_sk ) store ON c.c_customer_sk = store.customer_sk WHERE catalog.catalog_spending > COALESCE(store.store_spending, 0) AND c.c_preferred_cust_flag = 'Y';
