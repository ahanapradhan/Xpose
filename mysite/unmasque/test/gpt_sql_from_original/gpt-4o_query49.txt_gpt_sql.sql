WITH sales_returns AS ( SELECT 'catalog' AS channel, cs_item_sk AS item_sk, SUM(cs_quantity) AS total_sales_quantity, COALESCE(SUM(cr_return_quantity), 0) AS total_return_quantity, COALESCE(SUM(cr_return_amount), 0) AS total_return_amount, SUM(cs_net_paid) AS total_net_paid FROM catalog_sales LEFT JOIN catalog_returns ON cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number GROUP BY cs_item_sk UNION ALL SELECT 'store' AS channel, ss_item_sk AS item_sk, SUM(ss_quantity) AS total_sales_quantity, COALESCE(SUM(sr_return_quantity), 0) AS total_return_quantity, COALESCE(SUM(sr_return_amt), 0) AS total_return_amount, SUM(ss_net_paid) AS total_net_paid FROM store_sales LEFT JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number GROUP BY ss_item_sk UNION ALL SELECT 'web' AS channel, ws_item_sk AS item_sk, SUM(ws_quantity) AS total_sales_quantity, COALESCE(SUM(wr_return_quantity), 0) AS total_return_quantity, COALESCE(SUM(wr_return_amt), 0) AS total_return_amount, SUM(ws_net_paid) AS total_net_paid FROM web_sales LEFT JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number GROUP BY ws_item_sk ) SELECT channel, item_sk, CASE WHEN total_return_quantity = 0 THEN NULL ELSE total_sales_quantity / total_return_quantity END AS quantity_ratio, CASE WHEN total_net_paid = 0 THEN NULL ELSE total_return_amount / total_net_paid END AS currency_ratio FROM sales_returns ORDER BY quantity_ratio, currency_ratio;
