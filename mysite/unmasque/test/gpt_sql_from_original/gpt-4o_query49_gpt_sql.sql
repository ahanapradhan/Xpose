SELECT channel, i_item_id, MIN(quantity_ratio) AS worst_quantity_ratio, MIN(currency_ratio) AS worst_currency_ratio FROM ( SELECT 'Catalog' AS channel, i.i_item_id, SUM(cs.cs_quantity) / NULLIF(SUM(cr.cr_return_quantity), 0) AS quantity_ratio, SUM(cr.cr_return_amount) / NULLIF(SUM(cs.cs_net_paid), 0) AS currency_ratio FROM catalog_sales cs JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk GROUP BY i.i_item_id UNION ALL SELECT 'Store' AS channel, i.i_item_id, SUM(ss.ss_quantity) / NULLIF(SUM(sr.sr_return_quantity), 0) AS quantity_ratio, SUM(sr.sr_return_amt) / NULLIF(SUM(ss.ss_net_paid), 0) AS currency_ratio FROM store_sales ss JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk GROUP BY i.i_item_id UNION ALL SELECT 'Web' AS channel, i.i_item_id, SUM(ws.ws_quantity) / NULLIF(SUM(wr.wr_return_quantity), 0) AS quantity_ratio, SUM(wr.wr_return_amt) / NULLIF(SUM(ws.ws_net_paid), 0) AS currency_ratio FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk GROUP BY i.i_item_id ) AS combined GROUP BY channel, i_item_id ORDER BY worst_quantity_ratio, worst_currency_ratio;
