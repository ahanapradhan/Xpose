SELECT channel, i_item_id, quantity_ratio, currency_ratio FROM ( SELECT 'Catalog' AS channel, i.i_item_id, COALESCE(SUM(cs.cs_quantity), 0) / NULLIF(SUM(cr.cr_return_quantity), 0) AS quantity_ratio, COALESCE(SUM(cr.cr_return_amount), 0) / NULLIF(SUM(cs.cs_net_paid), 0) AS currency_ratio FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk LEFT JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_month_seq = 12 AND d.d_year = 2001 GROUP BY i.i_item_id UNION ALL SELECT 'Store' AS channel, i.i_item_id, COALESCE(SUM(ss.ss_quantity), 0) / NULLIF(SUM(sr.sr_return_quantity), 0) AS quantity_ratio, COALESCE(SUM(sr.sr_return_amt), 0) / NULLIF(SUM(ss.ss_net_paid), 0) AS currency_ratio FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq = 12 AND d.d_year = 2001 GROUP BY i.i_item_id UNION ALL SELECT 'Web' AS channel, i.i_item_id, COALESCE(SUM(ws.ws_quantity), 0) / NULLIF(SUM(wr.wr_return_quantity), 0) AS quantity_ratio, COALESCE(SUM(wr.wr_return_amt), 0) / NULLIF(SUM(ws.ws_net_paid), 0) AS currency_ratio FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk LEFT JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE d.d_month_seq = 12 AND d.d_year = 2001 GROUP BY i.i_item_id ) AS combined ORDER BY quantity_ratio, currency_ratio;
