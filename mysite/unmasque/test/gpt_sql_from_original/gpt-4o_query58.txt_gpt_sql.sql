WITH weekly_revenue AS ( SELECT ss_item_sk AS item_sk, SUM(ss_net_paid) AS store_revenue, SUM(cs_net_paid) AS catalog_revenue, SUM(ws_net_paid) AS web_revenue FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN catalog_sales ON cs_sold_date_sk = d_date_sk JOIN web_sales ON ws_sold_date_sk = d_date_sk WHERE d_date BETWEEN CAST(? AS DATE) - INTERVAL '6 DAY' AND CAST(? AS DATE) GROUP BY ss_item_sk ), balanced_revenue AS ( SELECT item_sk, store_revenue + catalog_revenue + web_revenue AS total_revenue FROM weekly_revenue WHERE ABS(store_revenue - catalog_revenue) <= 0.1 * store_revenue AND ABS(store_revenue - web_revenue) <= 0.1 * store_revenue AND ABS(catalog_revenue - web_revenue) <= 0.1 * catalog_revenue ) SELECT item_sk FROM balanced_revenue ORDER BY total_revenue DESC LIMIT 1;
