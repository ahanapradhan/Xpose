WITH YearlySales AS ( SELECT c.c_customer_id, d.d_year, SUM(CASE WHEN ss.ss_sold_date_sk IS NOT NULL THEN ss.ss_net_paid ELSE 0 END) AS store_sales, SUM(CASE WHEN ws.ws_sold_date_sk IS NOT NULL THEN ws.ws_net_paid ELSE 0 END) AS web_sales FROM customer c LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk JOIN date_dim d ON (ss.ss_sold_date_sk = d.d_date_sk OR ws.ws_sold_date_sk = d.d_date_sk) GROUP BY c.c_customer_id, d.d_year ), SalesGrowth AS ( SELECT y1.c_customer_id, y1.d_year, y1.web_sales - COALESCE(y2.web_sales, 0) AS web_sales_growth, y1.store_sales - COALESCE(y2.store_sales, 0) AS store_sales_growth FROM YearlySales y1 LEFT JOIN YearlySales y2 ON y1.c_customer_id = y2.c_customer_id AND y1.d_year = y2.d_year + 1 ) SELECT sg.c_customer_id FROM SalesGrowth sg WHERE sg.d_year = specified_year AND sg.web_sales_growth > sg.store_sales_growth AND sg.web_sales_growth > 0 AND sg.store_sales_growth > 0; Replace `specified_year` with the actual year you want to specify.
