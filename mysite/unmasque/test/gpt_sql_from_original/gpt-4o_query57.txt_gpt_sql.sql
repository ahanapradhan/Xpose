WITH MonthlySales AS ( SELECT cs.cs_call_center_sk, i.i_brand, i.i_category, d.d_month_seq, SUM(cs.cs_ext_sales_price) AS monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = ? -- specified year GROUP BY cs.cs_call_center_sk, i.i_brand, i.i_category, d.d_month_seq ), AverageMonthlySales AS ( SELECT cs_call_center_sk, i_brand, i_category, AVG(monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY cs_call_center_sk, i_brand, i_category ), SalesDeviation AS ( SELECT ms.cs_call_center_sk, ms.i_brand, ms.i_category, ms.d_month_seq, ms.monthly_sales, ams.avg_monthly_sales, (ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales * 100 AS deviation FROM MonthlySales ms JOIN AverageMonthlySales ams ON ms.cs_call_center_sk = ams.cs_call_center_sk AND ms.i_brand = ams.i_brand AND ms.i_category = ams.i_category WHERE ABS((ms.monthly_sales - ams.avg_monthly_sales) / ams.avg_monthly_sales * 100) > 10 ), SalesDeviationWithNeighbors AS ( SELECT sd.cs_call_center_sk, sd.i_brand, sd.i_category, sd.d_month_seq, sd.monthly_sales, sd.deviation, LAG(sd.monthly_sales) OVER (PARTITION BY sd.cs_call_center_sk, sd.i_brand, sd.i_category ORDER BY sd.d_month_seq) AS prev_month_sales, LEAD(sd.monthly_sales) OVER (PARTITION BY sd.cs_call_center_sk, sd.i_brand, sd.i_category ORDER BY sd.d_month_seq) AS next_month_sales FROM SalesDeviation sd ) SELECT cc.cc_name AS call_center_name, sdwn.i_brand, sdwn.i_category, sdwn.d_month_seq, sdwn.monthly_sales, sdwn.deviation, sdwn.prev_month_sales, sdwn.next_month_sales FROM SalesDeviationWithNeighbors sdwn JOIN call_center cc ON sdwn.cs_call_center_sk = cc.cc_call_center_sk ORDER BY sdwn.deviation DESC, cc.cc_name;
