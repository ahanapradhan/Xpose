WITH InventoryStats AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, AVG(inv_quantity_on_hand) AS mean_quantity, STDDEV(inv_quantity_on_hand) AS stddev_quantity FROM inventory JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY inv_item_sk, inv_warehouse_sk, d_month_seq ), COVStats AS ( SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, stddev_quantity / NULLIF(mean_quantity, 0) AS cov FROM InventoryStats ), HighCOVItems AS ( SELECT a.inv_item_sk, a.inv_warehouse_sk, a.d_month_seq, a.cov AS cov_current, b.cov AS cov_previous FROM COVStats a JOIN COVStats b ON a.inv_item_sk = b.inv_item_sk AND a.inv_warehouse_sk = b.inv_warehouse_sk AND a.d_month_seq = b.d_month_seq + 1 WHERE a.cov > 1 ) SELECT inv_item_sk, inv_warehouse_sk, d_month_seq, cov_current, cov_previous FROM HighCOVItems WHERE cov_previous > 1.5;
