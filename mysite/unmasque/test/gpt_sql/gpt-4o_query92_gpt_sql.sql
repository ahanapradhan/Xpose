SELECT i.i_item_id, SUM(ws.ws_ext_discount_amt - 1.3 * avg_discount) AS total_excess_discount FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN ( SELECT ws_inner.ws_item_sk, AVG(ws_inner.ws_ext_discount_amt) AS avg_discount FROM web_sales ws_inner JOIN item i_inner ON ws_inner.ws_item_sk = i_inner.i_item_sk JOIN date_dim d_inner ON ws_inner.ws_sold_date_sk = d_inner.d_date_sk WHERE i_inner.i_manufact_id = 718 AND d_inner.d_date BETWEEN '2002-03-29' AND '2002-06-26' GROUP BY ws_inner.ws_item_sk ) avg_discounts ON ws.ws_item_sk = avg_discounts.ws_item_sk WHERE i.i_manufact_id = 718 AND d.d_date BETWEEN '2002-03-29' AND '2002-06-26' AND ws.ws_ext_discount_amt > 1.3 * avg_discount GROUP BY i.i_item_id ORDER BY total_excess_discount DESC LIMIT 100;
