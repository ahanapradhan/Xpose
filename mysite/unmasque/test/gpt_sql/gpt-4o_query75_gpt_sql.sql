WITH sales_data AS ( SELECT i_brand, i_class, i_category, i_manufact, d_year, SUM(cs_quantity) AS catalog_sales_count, SUM(cs_net_paid) AS catalog_sales_amount, SUM(ss_quantity) AS store_sales_count, SUM(ss_net_paid) AS store_sales_amount, SUM(ws_quantity) AS web_sales_count, SUM(ws_net_paid) AS web_sales_amount, SUM(cr_return_quantity) AS catalog_returns_count, SUM(cr_return_amount) AS catalog_returns_amount, SUM(sr_return_quantity) AS store_returns_count, SUM(sr_return_amt) AS store_returns_amount, SUM(wr_return_quantity) AS web_returns_count, SUM(wr_return_amt) AS web_returns_amount FROM item JOIN catalog_sales ON i_item_sk = cs_item_sk JOIN store_sales ON i_item_sk = ss_item_sk JOIN web_sales ON i_item_sk = ws_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk LEFT JOIN catalog_returns ON i_item_sk = cr_item_sk AND cr_returned_date_sk = d_date_sk LEFT JOIN store_returns ON i_item_sk = sr_item_sk AND sr_returned_date_sk = d_date_sk LEFT JOIN web_returns ON i_item_sk = wr_item_sk AND wr_returned_date_sk = d_date_sk WHERE i_category = 'Men' AND d_year IN (2001, 2002) GROUP BY i_brand, i_class, i_category, i_manufact, d_year ), sales_comparison AS ( SELECT sd1.i_brand, sd1.i_class, sd1.i_category, sd1.i_manufact, sd1.catalog_sales_count - COALESCE(sd1.catalog_returns_count, 0) AS net_catalog_sales_count_2001, sd2.catalog_sales_count - COALESCE(sd2.catalog_returns_count, 0) AS net_catalog_sales_count_2002, sd1.store_sales_count - COALESCE(sd1.store_returns_count, 0) AS net_store_sales_count_2001, sd2.store_sales_count - COALESCE(sd2.store_returns_count, 0) AS net_store_sales_count_2002, sd1.web_sales_count - COALESCE(sd1.web_returns_count, 0) AS net_web_sales_count_2001, sd2.web_sales_count - COALESCE(sd2.web_returns_count, 0) AS net_web_sales_count_2002 FROM sales_data sd1 JOIN sales_data sd2 ON sd1.i_brand = sd2.i_brand AND sd1.i_class = sd2.i_class AND sd1.i_category = sd2.i_category AND sd1.i_manufact = sd2.i_manufact AND sd1.d_year = 2001 AND sd2.d_year = 2002 ) SELECT i_brand, i_class, i_category, i_manufact, net_catalog_sales_count_2001, net_catalog_sales_count_2002, net_store_sales_count_2001, net_store_sales_count_2002, net_web_sales_count_2001, net_web_sales_count_2002 FROM sales_comparison WHERE (net_catalog_sales_count_2001 > 0 AND (net_catalog_sales_count_2002 / net_catalog_sales_count_2001) < 0.9) OR (net_store_sales_count_2001 > 0 AND (net_store_sales_count_2002 / net_store_sales_count_2001) < 0.9) OR (net_web_sales_count_2001 > 0 AND (net_web_sales_count_2002 / net_web_sales_count_2001) < 0.9) ORDER BY LEAST( CASE WHEN net_catalog_sales_count_2001 > 0 THEN (net_catalog_sales_count_2002 / net_catalog_sales_count_2001) ELSE 1 END, CASE WHEN net_store_sales_count_2001 > 0 THEN (net_store_sales_count_2002 / net_store_sales_count_2001) ELSE 1 END, CASE WHEN net_web_sales_count_2001 > 0 THEN (net_web_sales_count_2002 / net_web_sales_count_2001) ELSE 1 END ) ASC LIMIT 100;
