WITH ProductNetProfit AS ( SELECT ss_item_sk, AVG(ss_net_profit) AS avg_net_profit FROM store_sales WHERE ss_store_sk = 4 GROUP BY ss_item_sk ), RankedProducts AS ( SELECT pnp.ss_item_sk, pnp.avg_net_profit, RANK() OVER (ORDER BY pnp.avg_net_profit DESC) AS rank_desc, RANK() OVER (ORDER BY pnp.avg_net_profit ASC) AS rank_asc FROM ProductNetProfit pnp ), TopProducts AS ( SELECT rp.ss_item_sk, rp.avg_net_profit, i.i_product_name, rp.rank_desc, rp.rank_asc FROM RankedProducts rp JOIN item i ON rp.ss_item_sk = i.i_item_sk WHERE rp.rank_desc <= 10 OR rp.rank_asc <= 10 ) SELECT * FROM TopProducts ORDER BY rank_desc, rank_asc LIMIT 100;
