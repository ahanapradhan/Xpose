WITH MonthlySales AS ( SELECT i.i_category, i.i_brand, cc.cc_call_center_id, d.d_year, d.d_moy, SUM(cs.cs_ext_sales_price) AS total_sales, AVG(SUM(cs.cs_ext_sales_price)) OVER (PARTITION BY i.i_category, i.i_brand, cc.cc_call_center_id, d.d_year) AS avg_monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2000 GROUP BY i.i_category, i.i_brand, cc.cc_call_center_id, d.d_year, d.d_moy ), SalesDeviation AS ( SELECT ms.*, LAG(ms.total_sales) OVER (PARTITION BY ms.i_category, ms.i_brand, ms.cc_call_center_id ORDER BY ms.d_year, ms.d_moy) AS prev_month_sales, LEAD(ms.total_sales) OVER (PARTITION BY ms.i_category, ms.i_brand, ms.cc_call_center_id ORDER BY ms.d_year, ms.d_moy) AS next_month_sales, (ms.total_sales - ms.avg_monthly_sales) / ms.avg_monthly_sales * 100 AS deviation_percentage FROM MonthlySales ms ) SELECT i_category, i_brand, cc_call_center_id, d_year, d_moy, total_sales, avg_monthly_sales, deviation_percentage FROM SalesDeviation WHERE avg_monthly_sales > 0 AND ABS(deviation_percentage) > 10 ORDER BY ABS(deviation_percentage) DESC LIMIT 100;
