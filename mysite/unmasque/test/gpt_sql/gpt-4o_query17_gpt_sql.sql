SELECT i.i_item_id, i.i_item_desc, COALESCE(s.s_state, ca.ca_state) AS state, COUNT(ss.ss_quantity) AS store_sales_count, AVG(ss.ss_quantity) AS store_sales_avg, STDDEV(ss.ss_quantity) AS store_sales_stddev, CASE WHEN AVG(ss.ss_quantity) = 0 THEN 0 ELSE STDDEV(ss.ss_quantity) / AVG(ss.ss_quantity) END AS store_sales_cov, COUNT(sr.sr_return_quantity) AS store_returns_count, AVG(sr.sr_return_quantity) AS store_returns_avg, STDDEV(sr.sr_return_quantity) AS store_returns_stddev, CASE WHEN AVG(sr.sr_return_quantity) = 0 THEN 0 ELSE STDDEV(sr.sr_return_quantity) / AVG(sr.sr_return_quantity) END AS store_returns_cov, COUNT(cs.cs_quantity) AS catalog_sales_count, AVG(cs.cs_quantity) AS catalog_sales_avg, STDDEV(cs.cs_quantity) AS catalog_sales_stddev, CASE WHEN AVG(cs.cs_quantity) = 0 THEN 0 ELSE STDDEV(cs.cs_quantity) / AVG(cs.cs_quantity) END AS catalog_sales_cov, COUNT(cr.cr_return_quantity) AS catalog_returns_count, AVG(cr.cr_return_quantity) AS catalog_returns_avg, STDDEV(cr.cr_return_quantity) AS catalog_returns_stddev, CASE WHEN AVG(cr.cr_return_quantity) = 0 THEN 0 ELSE STDDEV(cr.cr_return_quantity) / AVG(cr.cr_return_quantity) END AS catalog_returns_cov FROM item i LEFT JOIN store_sales ss ON i.i_item_sk = ss.ss_item_sk LEFT JOIN store s ON ss.ss_store_sk = s.s_store_sk LEFT JOIN store_returns sr ON i.i_item_sk = sr.sr_item_sk LEFT JOIN catalog_sales cs ON i.i_item_sk = cs.cs_item_sk LEFT JOIN catalog_page cp ON cs.cs_catalog_page_sk = cp.cp_catalog_page_sk LEFT JOIN catalog_returns cr ON i.i_item_sk = cr.cr_item_sk LEFT JOIN customer_address ca ON cs.cs_ship_addr_sk = ca.ca_address_sk LEFT JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 AND d.d_qoy IN (1, 2, 3) GROUP BY i.i_item_id, i.i_item_desc, state ORDER BY i.i_item_id, i.i_item_desc, state LIMIT 100;
