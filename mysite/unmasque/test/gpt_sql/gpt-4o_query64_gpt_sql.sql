SELECT i.i_product_name, s.s_store_name, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, SUM(CASE WHEN d.d_year = 2001 THEN ss.ss_quantity ELSE 0 END) AS sales_count_2001, SUM(CASE WHEN d.d_year = 2002 THEN ss.ss_quantity ELSE 0 END) AS sales_count_2002, SUM(CASE WHEN d.d_year = 2001 THEN ss.ss_wholesale_cost ELSE 0 END) AS wholesale_cost_2001, SUM(CASE WHEN d.d_year = 2002 THEN ss.ss_wholesale_cost ELSE 0 END) AS wholesale_cost_2002, SUM(CASE WHEN d.d_year = 2001 THEN ss.ss_list_price ELSE 0 END) AS list_price_2001, SUM(CASE WHEN d.d_year = 2002 THEN ss.ss_list_price ELSE 0 END) AS list_price_2002, SUM(CASE WHEN d.d_year = 2001 THEN ss.ss_coupon_amt ELSE 0 END) AS coupon_amt_2001, SUM(CASE WHEN d.d_year = 2002 THEN ss.ss_coupon_amt ELSE 0 END) AS coupon_amt_2002 FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number WHERE d.d_year IN (2001, 2002) AND i.i_color IN ('Red', 'Blue', 'Green') AND i.i_current_price BETWEEN 10 AND 100 AND (ss.ss_ext_sales_price - COALESCE(sr.sr_return_amt, 0)) > 1000 GROUP BY i.i_product_name, s.s_store_name, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status ORDER BY i.i_product_name, s.s_store_name, sales_count_2001 DESC, sales_count_2002 DESC;
