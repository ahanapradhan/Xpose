WITH MonthlySales AS ( SELECT i.i_category, i.i_brand, s.s_store_id, s.s_company_id, d.d_year, d.d_moy, SUM(ss.ss_ext_sales_price) AS total_sales, AVG(SUM(ss.ss_ext_sales_price)) OVER (PARTITION BY i.i_category, i.i_brand, s.s_store_id, s.s_company_id, d.d_year) AS avg_monthly_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 GROUP BY i.i_category, i.i_brand, s.s_store_id, s.s_company_id, d.d_year, d.d_moy ), SalesDeviation AS ( SELECT i_category, i_brand, s_store_id, s_company_id, d_year, d_moy, total_sales, avg_monthly_sales, (total_sales - avg_monthly_sales) / avg_monthly_sales AS sales_deviation FROM MonthlySales WHERE ABS((total_sales - avg_monthly_sales) / avg_monthly_sales) > 0.10 ) SELECT i_category, i_brand, s_store_id, s_company_id, d_year, d_moy, total_sales, avg_monthly_sales, sales_deviation FROM SalesDeviation ORDER BY ABS(sales_deviation) DESC LIMIT 100;
