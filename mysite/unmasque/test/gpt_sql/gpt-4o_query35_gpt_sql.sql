SELECT ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count, COUNT(*) AS customer_count, STDDEV(cd.cd_dep_count) AS dep_count_stddev, AVG(cd.cd_dep_count) AS avg_dep_count, MAX(cd.cd_dep_count) AS max_dep_count FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN date_dim d ON c.c_first_sales_date_sk = d.d_date_sk LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk AND ss.ss_sold_date_sk = d.d_date_sk LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk AND ws.ws_sold_date_sk = d.d_date_sk LEFT JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk AND cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2001 AND d.d_qoy IN (1, 2, 3) AND (ss.ss_customer_sk IS NOT NULL OR ws.ws_bill_customer_sk IS NOT NULL OR cs.cs_bill_customer_sk IS NOT NULL) GROUP BY ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count ORDER BY customer_count DESC LIMIT 100;
