SELECT s.s_store_name AS store_name, i.i_item_desc AS item_description, SUM(ss.ss_ext_sales_price) AS revenue, i.i_current_price AS current_price, i.i_wholesale_cost AS wholesale_cost, i.i_brand AS brand FROM store_sales ss JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_date BETWEEN DATE '2022-01-01' AND DATE '2022-12-31' GROUP BY s.s_store_name, i.i_item_desc, i.i_current_price, i.i_wholesale_cost, i.i_brand, s.s_store_sk HAVING SUM(ss.ss_ext_sales_price) <= 0.1 * ( SELECT AVG(total_revenue) FROM ( SELECT ss_inner.ss_store_sk, SUM(ss_inner.ss_ext_sales_price) AS total_revenue FROM store_sales ss_inner JOIN date_dim d_inner ON ss_inner.ss_sold_date_sk = d_inner.d_date_sk WHERE d_inner.d_date BETWEEN DATE '2022-01-01' AND DATE '2022-12-31' GROUP BY ss_inner.ss_store_sk ) AS store_avg_revenue WHERE store_avg_revenue.ss_store_sk = s.s_store_sk ) ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;
