SELECT i.i_category, i.i_class, SUM(ss.ss_net_profit) / NULLIF(SUM(ss.ss_ext_sales_price), 0) AS gross_margin, RANK() OVER (PARTITION BY i.i_category, i.i_class ORDER BY SUM(ss.ss_net_profit) / NULLIF(SUM(ss.ss_ext_sales_price), 0) DESC) AS rank_within_hierarchy FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 2000 AND s.s_state = 'TN' GROUP BY ROLLUP(i.i_category, i.i_class) ORDER BY GROUPING(i.i_category) ASC, GROUPING(i.i_class) ASC, rank_within_hierarchy ASC LIMIT 100;
