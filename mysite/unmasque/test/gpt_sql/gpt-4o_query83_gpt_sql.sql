WITH date_filtered AS ( SELECT d_date_sk FROM date_dim WHERE d_year = 1999 ), store_returns_agg AS ( SELECT sr_item_sk, SUM(sr_return_quantity) AS store_return_qty FROM store_returns WHERE sr_returned_date_sk IN (SELECT d_date_sk FROM date_filtered) GROUP BY sr_item_sk ), catalog_returns_agg AS ( SELECT cr_item_sk, SUM(cr_return_quantity) AS catalog_return_qty FROM catalog_returns WHERE cr_returned_date_sk IN (SELECT d_date_sk FROM date_filtered) GROUP BY cr_item_sk ), web_returns_agg AS ( SELECT wr_item_sk, SUM(wr_return_quantity) AS web_return_qty FROM web_returns WHERE wr_returned_date_sk IN (SELECT d_date_sk FROM date_filtered) GROUP BY wr_item_sk ), total_returns AS ( SELECT COALESCE(sra.sr_item_sk, cra.cr_item_sk, wra.wr_item_sk) AS item_sk, COALESCE(sra.store_return_qty, 0) AS store_return_qty, COALESCE(cra.catalog_return_qty, 0) AS catalog_return_qty, COALESCE(wra.web_return_qty, 0) AS web_return_qty FROM store_returns_agg sra FULL OUTER JOIN catalog_returns_agg cra ON sra.sr_item_sk = cra.cr_item_sk FULL OUTER JOIN web_returns_agg wra ON COALESCE(sra.sr_item_sk, cra.cr_item_sk) = wra.wr_item_sk ), total_and_percentage AS ( SELECT item_sk, store_return_qty, catalog_return_qty, web_return_qty, (store_return_qty + catalog_return_qty + web_return_qty) AS total_return_qty, (store_return_qty::DECIMAL / NULLIF((store_return_qty + catalog_return_qty + web_return_qty), 0)) * 100 AS store_percentage, (catalog_return_qty::DECIMAL / NULLIF((store_return_qty + catalog_return_qty + web_return_qty), 0)) * 100 AS catalog_percentage, (web_return_qty::DECIMAL / NULLIF((store_return_qty + catalog_return_qty + web_return_qty), 0)) * 100 AS web_percentage FROM total_returns ), average_returns AS ( SELECT item_sk, store_return_qty, catalog_return_qty, web_return_qty, total_return_qty, store_percentage, catalog_percentage, web_percentage, (store_return_qty + catalog_return_qty + web_return_qty) / 3.0 AS avg_return_qty FROM total_and_percentage ) SELECT i.i_item_id, ar.store_return_qty, ar.catalog_return_qty, ar.web_return_qty, ar.total_return_qty, ar.store_percentage, ar.catalog_percentage, ar.web_percentage, ar.avg_return_qty FROM average_returns ar JOIN item i ON ar.item_sk = i.i_item_sk ORDER BY i.i_item_id, ar.store_return_qty DESC LIMIT 100;
