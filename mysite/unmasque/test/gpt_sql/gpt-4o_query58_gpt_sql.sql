WITH sales_data AS ( SELECT i.i_item_id, COALESCE(SUM(ss.ss_net_paid), 0) AS store_sales_revenue, COALESCE(SUM(cs.cs_net_paid), 0) AS catalog_sales_revenue, COALESCE(SUM(ws.ws_net_paid), 0) AS web_sales_revenue, COALESCE(SUM(ss.ss_net_paid), 0) + COALESCE(SUM(cs.cs_net_paid), 0) + COALESCE(SUM(ws.ws_net_paid), 0) AS total_revenue FROM item i LEFT JOIN store_sales ss ON i.i_item_sk = ss.ss_item_sk LEFT JOIN catalog_sales cs ON i.i_item_sk = cs.cs_item_sk LEFT JOIN web_sales ws ON i.i_item_sk = ws.ws_item_sk LEFT JOIN date_dim d_ss ON ss.ss_sold_date_sk = d_ss.d_date_sk LEFT JOIN date_dim d_cs ON cs.cs_sold_date_sk = d_cs.d_date_sk LEFT JOIN date_dim d_ws ON ws.ws_sold_date_sk = d_ws.d_date_sk WHERE (d_ss.d_date BETWEEN '2002-02-18' AND '2002-02-24' OR d_cs.d_date BETWEEN '2002-02-18' AND '2002-02-24' OR d_ws.d_date BETWEEN '2002-02-18' AND '2002-02-24') GROUP BY i.i_item_id ), balanced_sales AS ( SELECT i_item_id, store_sales_revenue, catalog_sales_revenue, web_sales_revenue, total_revenue, (store_sales_revenue / total_revenue) * 100 AS store_sales_percentage, (catalog_sales_revenue / total_revenue) * 100 AS catalog_sales_percentage, (web_sales_revenue / total_revenue) * 100 AS web_sales_percentage FROM sales_data WHERE ABS(store_sales_revenue - catalog_sales_revenue) <= 0.1 * total_revenue AND ABS(store_sales_revenue - web_sales_revenue) <= 0.1 * total_revenue AND ABS(catalog_sales_revenue - web_sales_revenue) <= 0.1 * total_revenue ) SELECT i_item_id, store_sales_revenue, catalog_sales_revenue, web_sales_revenue, store_sales_percentage, catalog_sales_percentage, web_sales_percentage FROM balanced_sales ORDER BY i_item_id, store_sales_revenue DESC LIMIT 100;
