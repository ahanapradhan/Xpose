WITH sales_2001 AS ( SELECT cs_bill_customer_sk AS customer_sk, SUM(cs_sales_price) AS catalog_sales_2001 FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 2001 GROUP BY cs_bill_customer_sk ), sales_2002 AS ( SELECT cs_bill_customer_sk AS customer_sk, SUM(cs_sales_price) AS catalog_sales_2002 FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY cs_bill_customer_sk ), store_sales_2001 AS ( SELECT ss_customer_sk AS customer_sk, SUM(ss_sales_price) AS store_sales_2001 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2001 GROUP BY ss_customer_sk ), store_sales_2002 AS ( SELECT ss_customer_sk AS customer_sk, SUM(ss_sales_price) AS store_sales_2002 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY ss_customer_sk ), web_sales_2001 AS ( SELECT ws_bill_customer_sk AS customer_sk, SUM(ws_sales_price) AS web_sales_2001 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2001 GROUP BY ws_bill_customer_sk ), web_sales_2002 AS ( SELECT ws_bill_customer_sk AS customer_sk, SUM(ws_sales_price) AS web_sales_2002 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY ws_bill_customer_sk ) SELECT c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag FROM customer c JOIN sales_2001 s1 ON c.c_customer_sk = s1.customer_sk JOIN sales_2002 s2 ON c.c_customer_sk = s2.customer_sk JOIN store_sales_2001 ss1 ON c.c_customer_sk = ss1.customer_sk JOIN store_sales_2002 ss2 ON c.c_customer_sk = ss2.customer_sk JOIN web_sales_2001 ws1 ON c.c_customer_sk = ws1.customer_sk JOIN web_sales_2002 ws2 ON c.c_customer_sk = ws2.customer_sk WHERE s1.catalog_sales_2001 > 0 AND (s2.catalog_sales_2002 - s1.catalog_sales_2001) / NULLIF(s1.catalog_sales_2001, 0) > (ss2.store_sales_2002 - ss1.store_sales_2001) / NULLIF(ss1.store_sales_2001, 0) AND (s2.catalog_sales_2002 - s1.catalog_sales_2001) / NULLIF(s1.catalog_sales_2001, 0) > (ws2.web_sales_2002 - ws1.web_sales_2001) / NULLIF(ws1.web_sales_2001, 0) ORDER BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag LIMIT 100;
