WITH MonthlySales AS ( SELECT i.i_manager_id, i.i_category, i.i_class, i.i_brand, d.d_month_seq, SUM(cs.cs_ext_sales_price) AS total_sales, AVG(cs.cs_ext_sales_price) AS avg_monthly_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE i.i_category IN ('Books', 'Children', 'Electronics', 'Women', 'Music', 'Men') AND d.d_year = 2022 GROUP BY i.i_manager_id, i.i_category, i.i_class, i.i_brand, d.d_month_seq ), ManagerPerformance AS ( SELECT i_manager_id, i_category, i_class, i_brand, SUM(total_sales) AS total_sales, AVG(avg_monthly_sales) AS avg_monthly_sales FROM MonthlySales GROUP BY i_manager_id, i_category, i_class, i_brand ), Deviation AS ( SELECT *, (total_sales - avg_monthly_sales) / avg_monthly_sales * 100 AS deviation_percentage FROM ManagerPerformance ) SELECT i_manager_id, i_category, i_class, i_brand, total_sales, avg_monthly_sales, deviation_percentage FROM Deviation WHERE ABS(deviation_percentage) > 10 ORDER BY i_manager_id, avg_monthly_sales DESC, total_sales DESC LIMIT 100;
