SELECT COUNT(DISTINCT cs.cs_bill_customer_sk) AS customers_catalog_only, COUNT(DISTINCT ss.ss_customer_sk) AS customers_store_only, COUNT(DISTINCT cs.cs_bill_customer_sk) + COUNT(DISTINCT ss.ss_customer_sk) - COUNT(DISTINCT COALESCE(cs.cs_bill_customer_sk, ss.ss_customer_sk)) AS customers_both FROM (SELECT cs_bill_customer_sk FROM catalog_sales WHERE cs_sold_date_sk BETWEEN (SELECT d_date_sk FROM date_dim WHERE d_date = CURRENT_DATE - INTERVAL '1 year') AND (SELECT d_date_sk FROM date_dim WHERE d_date = CURRENT_DATE) GROUP BY cs_bill_customer_sk HAVING COUNT(DISTINCT cs_catalog_page_sk) > 0) cs FULL OUTER JOIN (SELECT ss_customer_sk FROM store_sales WHERE ss_sold_date_sk BETWEEN (SELECT d_date_sk FROM date_dim WHERE d_date = CURRENT_DATE - INTERVAL '1 year') AND (SELECT d_date_sk FROM date_dim WHERE d_date = CURRENT_DATE) GROUP BY ss_customer_sk HAVING COUNT(DISTINCT ss_store_sk) > 0) ss ON cs.cs_bill_customer_sk = ss.ss_customer_sk;
