WITH May2000Customers AS ( SELECT DISTINCT c.c_customer_sk FROM customer c JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '2000-05-01') UNION SELECT DISTINCT c.c_customer_sk FROM customer c JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE d.d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '2000-05-01') ), CustomerRevenue AS ( SELECT c.c_customer_sk, SUM(ss.ss_net_paid) AS total_revenue FROM May2000Customers c JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address ca ON c.c_customer_sk = ca.ca_address_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_month_seq BETWEEN (SELECT d_month_seq FROM date_dim WHERE d_date = '2000-06-01') AND (SELECT d_month_seq FROM date_dim WHERE d_date = '2000-08-31') AND ca.ca_street_number = s.s_street_number AND ca.ca_street_name = s.s_street_name AND ca.ca_street_type = s.s_street_type AND ca.ca_city = s.s_city AND ca.ca_state = s.s_state AND ca.ca_zip = s.s_zip GROUP BY c.c_customer_sk ), RevenueSegments AS ( SELECT FLOOR(total_revenue / 50) * 50 AS revenue_segment, COUNT(*) AS customer_count FROM CustomerRevenue GROUP BY FLOOR(total_revenue / 50) * 50 ) SELECT revenue_segment, customer_count FROM RevenueSegments ORDER BY revenue_segment;
