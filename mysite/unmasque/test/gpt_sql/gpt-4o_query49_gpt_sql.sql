WITH web_data AS ( SELECT ws_item_sk AS item_sk, SUM(wr_return_quantity) / NULLIF(SUM(ws_quantity), 0) AS return_ratio, SUM(wr_return_amt) / NULLIF(SUM(ws_net_paid), 0) AS currency_ratio FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy = 12 GROUP BY ws_item_sk ), catalog_data AS ( SELECT cs_item_sk AS item_sk, SUM(cr_return_quantity) / NULLIF(SUM(cs_quantity), 0) AS return_ratio, SUM(cr_return_amount) / NULLIF(SUM(cs_net_paid), 0) AS currency_ratio FROM catalog_sales JOIN catalog_returns ON cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy = 12 GROUP BY cs_item_sk ), store_data AS ( SELECT ss_item_sk AS item_sk, SUM(sr_return_quantity) / NULLIF(SUM(ss_quantity), 0) AS return_ratio, SUM(sr_return_amt) / NULLIF(SUM(ss_net_paid), 0) AS currency_ratio FROM store_sales JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy = 12 GROUP BY ss_item_sk ), ranked_web AS ( SELECT item_sk, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio DESC, currency_ratio DESC) AS rnk FROM web_data ), ranked_catalog AS ( SELECT item_sk, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio DESC, currency_ratio DESC) AS rnk FROM catalog_data ), ranked_store AS ( SELECT item_sk, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio DESC, currency_ratio DESC) AS rnk FROM store_data ) SELECT 'web' AS channel, item_sk, return_ratio, currency_ratio, rnk FROM ranked_web WHERE rnk <= 10 UNION ALL SELECT 'catalog' AS channel, item_sk, return_ratio, currency_ratio, rnk FROM ranked_catalog WHERE rnk <= 10 UNION ALL SELECT 'store' AS channel, item_sk, return_ratio, currency_ratio, rnk FROM ranked_store WHERE rnk <= 10 ORDER BY channel, rnk LIMIT 100;
