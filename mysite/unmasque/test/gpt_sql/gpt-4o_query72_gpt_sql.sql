SELECT i.i_item_desc AS item_description, w.w_warehouse_name AS warehouse_name, d.d_week_seq AS week_sequence, COUNT(cs.cs_order_number) AS total_sales, COUNT(CASE WHEN cs.cs_promo_sk IS NOT NULL THEN cs.cs_order_number END) AS sales_with_promo, COUNT(CASE WHEN cs.cs_promo_sk IS NULL THEN cs.cs_order_number END) AS sales_without_promo FROM catalog_sales cs JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk AND cs.cs_warehouse_sk = inv.inv_warehouse_sk AND cs.cs_sold_date_sk = inv.inv_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk WHERE cd.cd_marital_status = 'M' AND ib.ib_lower_bound >= 501 AND ib.ib_upper_bound <= 1000 AND d.d_year = 2002 AND inv.inv_quantity_on_hand < cs.cs_quantity AND cs.cs_ship_date_sk > cs.cs_sold_date_sk + 5 GROUP BY i.i_item_desc, w.w_warehouse_name, d.d_week_seq ORDER BY total_sales DESC LIMIT 100;
