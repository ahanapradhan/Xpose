WITH weekly_sales AS ( SELECT s.s_store_name, s.s_store_id, d.d_week_seq, d.d_dow, SUM(ss.ss_net_paid) AS total_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year IN (EXTRACT(YEAR FROM CURRENT_DATE), EXTRACT(YEAR FROM CURRENT_DATE) - 1) GROUP BY s.s_store_name, s.s_store_id, d.d_week_seq, d.d_dow ), sales_comparison AS ( SELECT ws1.s_store_name, ws1.s_store_id, ws1.d_week_seq, ws1.d_dow, ws1.total_sales AS current_year_sales, ws2.total_sales AS previous_year_sales, CASE WHEN ws2.total_sales = 0 THEN NULL ELSE ws1.total_sales / ws2.total_sales END AS sales_ratio FROM weekly_sales ws1 LEFT JOIN weekly_sales ws2 ON ws1.s_store_id = ws2.s_store_id AND ws1.d_dow = ws2.d_dow AND ws1.d_week_seq = ws2.d_week_seq + 52 WHERE ws1.d_week_seq > 52 ) SELECT s_store_name, s_store_id, d_week_seq, d_dow, current_year_sales, previous_year_sales, sales_ratio FROM sales_comparison ORDER BY s_store_name, s_store_id, d_week_seq LIMIT 100;
