WITH avg_sales AS ( SELECT i_brand, i_class, i_category, AVG(total_sales) AS avg_sales_value FROM ( SELECT i.i_brand, i.i_class, i.i_category, SUM(cs_ext_sales_price) AS total_sales FROM catalog_sales JOIN item i ON cs_item_sk = i.i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 2001 GROUP BY i.i_brand, i.i_class, i.i_category UNION ALL SELECT i.i_brand, i.i_class, i.i_category, SUM(ss_ext_sales_price) AS total_sales FROM store_sales JOIN item i ON ss_item_sk = i.i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 2001 GROUP BY i.i_brand, i.i_class, i.i_category UNION ALL SELECT i.i_brand, i.i_class, i.i_category, SUM(ws_ext_sales_price) AS total_sales FROM web_sales JOIN item i ON ws_item_sk = i.i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 2001 GROUP BY i.i_brand, i.i_class, i.i_category ) AS all_sales GROUP BY i_brand, i_class, i_category ) SELECT i.i_brand, i.i_class, i.i_category, SUM(cs_ext_sales_price) AS total_sales, COUNT(cs_order_number) AS num_transactions, 'Catalog' AS channel FROM catalog_sales JOIN item i ON cs_item_sk = i.i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN avg_sales ON i.i_brand = avg_sales.i_brand AND i.i_class = avg_sales.i_class AND i.i_category = avg_sales.i_category WHERE d_year = 2001 AND d_moy = 11 GROUP BY i.i_brand, i.i_class, i.i_category, avg_sales_value HAVING SUM(cs_ext_sales_price) > avg_sales_value UNION ALL SELECT i.i_brand, i.i_class, i.i_category, SUM(ss_ext_sales_price) AS total_sales, COUNT(ss_ticket_number) AS num_transactions, 'Store' AS channel FROM store_sales JOIN item i ON ss_item_sk = i.i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN avg_sales ON i.i_brand = avg_sales.i_brand AND i.i_class = avg_sales.i_class AND i.i_category = avg_sales.i_category WHERE d_year = 2001 AND d_moy = 11 GROUP BY i.i_brand, i.i_class, i.i_category, avg_sales_value HAVING SUM(ss_ext_sales_price) > avg_sales_value UNION ALL SELECT i.i_brand, i.i_class, i.i_category, SUM(ws_ext_sales_price) AS total_sales, COUNT(ws_order_number) AS num_transactions, 'Web' AS channel FROM web_sales JOIN item i ON ws_item_sk = i.i_item_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN avg_sales ON i.i_brand = avg_sales.i_brand AND i.i_class = avg_sales.i_class AND i.i_category = avg_sales.i_category WHERE d_year = 2001 AND d_moy = 11 GROUP BY i.i_brand, i.i_class, i.i_category, avg_sales_value HAVING SUM(ws_ext_sales_price) > avg_sales_value LIMIT 100; WITH avg_store_sales AS ( SELECT i_brand, i_class, i_category, AVG(total_sales) AS avg_sales_value FROM ( SELECT i.i_brand, i.i_class, i.i_category, SUM(ss_ext_sales_price) AS total_sales FROM store_sales JOIN item i ON ss_item_sk = i.i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 2000 AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2000-12-25') GROUP BY i.i_brand, i.i_class, i.i_category ) AS store_sales_data GROUP BY i_brand, i_class, i_category ) SELECT i.i_brand, i.i_class, i.i_category, SUM(ss_ext_sales_price) AS total_sales, COUNT(ss_ticket_number) AS num_transactions, 'Store' AS channel FROM store_sales JOIN item i ON ss_item_sk = i.i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN avg_store_sales ON i.i_brand = avg_store_sales.i_brand AND i.i_class = avg_store_sales.i_class AND i.i_category = avg_store_sales.i_category WHERE d_year IN (1999, 2000) AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2000-12-25') GROUP BY i.i_brand, i.i_class, i.i_category, avg_sales_value HAVING SUM(ss_ext_sales_price) > avg_sales_value ORDER BY channel, i.i_brand, i.i_class, i.i_category LIMIT 100;
