WITH TopCustomers AS ( SELECT ss_customer_sk FROM store_sales WHERE ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 6 ) GROUP BY ss_customer_sk HAVING SUM(ss_net_paid) > 0.95 * ( SELECT MAX(total_sales) FROM ( SELECT SUM(ss_net_paid) AS total_sales FROM store_sales WHERE ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 2001 ) GROUP BY ss_customer_sk ) AS subquery ) ), FrequentlySoldItems AS ( SELECT ss_item_sk FROM store_sales WHERE ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 2001 ) GROUP BY ss_item_sk HAVING COUNT(*) > 1 ) SELECT SUM(cs_net_paid) AS total_catalog_sales FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN TopCustomers ON cs_bill_customer_sk = TopCustomers.ss_customer_sk JOIN FrequentlySoldItems ON cs_item_sk = FrequentlySoldItems.ss_item_sk WHERE d_year = 1998 AND d_moy = 6 UNION ALL SELECT SUM(ws_net_paid) AS total_web_sales FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN TopCustomers ON ws_bill_customer_sk = TopCustomers.ss_customer_sk JOIN FrequentlySoldItems ON ws_item_sk = FrequentlySoldItems.ss_item_sk WHERE d_year = 1998 AND d_moy = 6; WITH TopCustomers AS ( SELECT ss_customer_sk FROM store_sales WHERE ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 6 ) GROUP BY ss_customer_sk HAVING SUM(ss_net_paid) > 0.95 * ( SELECT MAX(total_sales) FROM ( SELECT SUM(ss_net_paid) AS total_sales FROM store_sales WHERE ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 2001 ) GROUP BY ss_customer_sk ) AS subquery ) ) SELECT c.c_first_name, c.c_last_name, SUM(ss_net_paid) AS total_store_sales FROM store_sales ss JOIN TopCustomers tc ON ss.ss_customer_sk = tc.ss_customer_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_sold_date_sk IN ( SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 2001 ) GROUP BY c.c_first_name, c.c_last_name ORDER BY total_store_sales DESC;
