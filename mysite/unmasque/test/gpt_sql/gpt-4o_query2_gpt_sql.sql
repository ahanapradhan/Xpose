WITH weekly_sales_1998 AS ( SELECT d_week_seq, d_dow, COALESCE(SUM(cs_sales_price), 0) AS catalog_sales, COALESCE(SUM(ws_sales_price), 0) AS web_sales FROM date_dim LEFT JOIN catalog_sales ON d_date_sk = cs_sold_date_sk LEFT JOIN web_sales ON d_date_sk = ws_sold_date_sk WHERE d_year = 1998 GROUP BY d_week_seq, d_dow ), weekly_sales_1999 AS ( SELECT d_week_seq, d_dow, COALESCE(SUM(cs_sales_price), 0) AS catalog_sales, COALESCE(SUM(ws_sales_price), 0) AS web_sales FROM date_dim LEFT JOIN catalog_sales ON d_date_sk = cs_sold_date_sk LEFT JOIN web_sales ON d_date_sk = ws_sold_date_sk WHERE d_year = 1999 GROUP BY d_week_seq, d_dow ) SELECT ws98.d_week_seq AS week_1998, ws99.d_week_seq AS week_1999, ws98.d_dow, ws98.catalog_sales / NULLIF(ws99.catalog_sales, 0) AS catalog_sales_ratio, ws98.web_sales / NULLIF(ws99.web_sales, 0) AS web_sales_ratio FROM weekly_sales_1998 ws98 JOIN weekly_sales_1999 ws99 ON ws98.d_week_seq = ws99.d_week_seq - 53 ORDER BY ws98.d_week_seq, ws98.d_dow;
