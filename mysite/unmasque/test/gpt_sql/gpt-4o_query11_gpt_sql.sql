WITH sales_2001 AS ( SELECT ss_customer_sk AS customer_sk, SUM(ss_ext_sales_price) AS store_sales_2001, 0 AS web_sales_2001 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2001 GROUP BY ss_customer_sk UNION ALL SELECT ws_bill_customer_sk AS customer_sk, 0 AS store_sales_2001, SUM(ws_ext_sales_price) AS web_sales_2001 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2001 GROUP BY ws_bill_customer_sk ), sales_2002 AS ( SELECT ss_customer_sk AS customer_sk, SUM(ss_ext_sales_price) AS store_sales_2002, 0 AS web_sales_2002 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY ss_customer_sk UNION ALL SELECT ws_bill_customer_sk AS customer_sk, 0 AS store_sales_2002, SUM(ws_ext_sales_price) AS web_sales_2002 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2002 GROUP BY ws_bill_customer_sk ), sales_growth AS ( SELECT COALESCE(s1.customer_sk, s2.customer_sk) AS customer_sk, COALESCE(s1.store_sales_2001, 0) AS store_sales_2001, COALESCE(s1.web_sales_2001, 0) AS web_sales_2001, COALESCE(s2.store_sales_2002, 0) AS store_sales_2002, COALESCE(s2.web_sales_2002, 0) AS web_sales_2002, COALESCE(s2.store_sales_2002, 0) - COALESCE(s1.store_sales_2001, 0) AS store_sales_growth, COALESCE(s2.web_sales_2002, 0) - COALESCE(s1.web_sales_2001, 0) AS web_sales_growth FROM sales_2001 s1 FULL OUTER JOIN sales_2002 s2 ON s1.customer_sk = s2.customer_sk ), filtered_customers AS ( SELECT customer_sk, store_sales_growth, web_sales_growth FROM sales_growth WHERE web_sales_growth > store_sales_growth ) SELECT c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country FROM filtered_customers fc JOIN customer c ON fc.customer_sk = c.c_customer_sk ORDER BY fc.web_sales_growth - fc.store_sales_growth DESC LIMIT 100;
