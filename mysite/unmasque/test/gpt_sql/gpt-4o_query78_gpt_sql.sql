WITH store_sales_1999 AS ( SELECT ss_item_sk, SUM(ss_quantity) AS store_quantity, SUM(ss_wholesale_cost) AS store_wholesale_cost, SUM(ss_sales_price) AS store_sales_price FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 GROUP BY ss_item_sk ), web_sales_1999 AS ( SELECT ws_item_sk, SUM(ws_quantity) AS web_quantity, SUM(ws_wholesale_cost) AS web_wholesale_cost, SUM(ws_sales_price) AS web_sales_price FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 1999 GROUP BY ws_item_sk ), catalog_sales_1999 AS ( SELECT cs_item_sk, SUM(cs_quantity) AS catalog_quantity, SUM(cs_wholesale_cost) AS catalog_wholesale_cost, SUM(cs_sales_price) AS catalog_sales_price FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 1999 GROUP BY cs_item_sk ), combined_sales AS ( SELECT ss.ss_item_sk, ss.store_quantity, ss.store_wholesale_cost, ss.store_sales_price, COALESCE(ws.web_quantity, 0) + COALESCE(cs.catalog_quantity, 0) AS other_channels_quantity, COALESCE(ws.web_wholesale_cost, 0) + COALESCE(cs.catalog_wholesale_cost, 0) AS other_channels_wholesale_cost, COALESCE(ws.web_sales_price, 0) + COALESCE(cs.catalog_sales_price, 0) AS other_channels_sales_price FROM store_sales_1999 ss JOIN web_sales_1999 ws ON ss.ss_item_sk = ws.ws_item_sk JOIN catalog_sales_1999 cs ON ss.ss_item_sk = cs.cs_item_sk ) SELECT i.i_item_id, cs.store_quantity, cs.store_wholesale_cost, cs.store_sales_price, cs.other_channels_quantity, cs.other_channels_wholesale_cost, cs.other_channels_sales_price, cs.store_quantity / NULLIF(cs.other_channels_quantity, 0) AS store_to_other_ratio FROM combined_sales cs JOIN item i ON cs.ss_item_sk = i.i_item_sk ORDER BY cs.store_quantity DESC, cs.store_wholesale_cost DESC, cs.store_sales_price DESC LIMIT 100;
